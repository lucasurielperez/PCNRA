<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limonero Interactivo</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    canvas { width: 100%; height: 80vh; display: block; }
    #instructions { text-align: center; font-size: 1.2em; padding: 10px; }
  </style>
</head>
<body>
  <canvas id="treeCanvas"></canvas>
  <div id="instructions">Ara la tierra moviendo el celular</div>
  <script>
    const canvas = document.getElementById('treeCanvas');
    const ctx = canvas.getContext('2d');
    const instructions = document.getElementById('instructions');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.8;

    let stage = 0;
    let progress = 0;
    const stages = [
      "Ara la tierra moviendo el celular",
      "Riega la planta con ruido de agua",
      "Dale luz al brote con la cámara",
      "Protege del viento manteniendo el celular quieto",
      "Nutre el suelo tocando la pantalla",
      "Poda las ramas inclinando el celular",
      "Ahuyenta plagas con un grito",
      "Dale más luz para las flores",
      "Poliniza agitando el celular",
      "Cosecha los limones tocándolos"
    ];

    // Cargar imágenes (ajusta las rutas si las tienes)
    const images = [];
    for (let i = 0; i < 10; i++) {
      images[i] = new Image();
      images[i].src = `stage${i}.png`; // Asume imágenes predefinidas
    }

    function drawTree() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (images[stage].complete) {
        ctx.drawImage(images[stage], canvas.width / 4, 0, canvas.width / 2, canvas.height);
      } else {
        ctx.fillText(`Etapa ${stage}`, canvas.width / 2, canvas.height / 2); // Fallback
      }
    }

    function nextStage() {
      stage++;
      progress = 0;
      if (stage < stages.length) {
        instructions.textContent = stages[stage];
        drawTree();
      } else {
        instructions.textContent = "¡Felicidades! Cosechaste los limones.";
      }
    }

    // Etapa 1: Movimiento (arar)
    let shakes = 0;
    window.addEventListener('devicemotion', (event) => {
      if (stage === 0) {
        if (Math.abs(event.acceleration.x) > 5 || Math.abs(event.acceleration.y) > 5) {
          shakes++;
          if (shakes > 10) nextStage();
        }
      } else if (stage === 8) { // Polinizar
        if (Math.abs(event.acceleration.x) > 3) {
          progress += 0.1;
          if (progress >= 1) nextStage();
        }
      } else if (stage === 3) { // Proteger del viento
        if (Math.abs(event.acceleration.x) < 1 && Math.abs(event.acceleration.y) < 1) {
          progress += 0.01;
          if (progress >= 1) nextStage();
        } else {
          progress = 0;
        }
      }
    });

    // Etapa 2 y 7: Sonido (regar y plagas)
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      const audioContext = new AudioContext();
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      function checkSound() {
        analyser.getByteFrequencyData(dataArray);
        let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
        if (stage === 1 && volume > 50) { // Regar
          progress += 0.1;
          if (progress >= 1) nextStage();
        } else if (stage === 6 && volume > 80) { // Plagas
          progress += 0.2;
          if (progress >= 1) nextStage();
        }
        requestAnimationFrame(checkSound);
      }
      checkSound();
    });

    // Etapa 3 y 8: Luz (brote y flores)
    const video = document.createElement('video');
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      video.play();
      const lightCanvas = document.createElement('canvas');
      const lightCtx = lightCanvas.getContext('2d');
      lightCanvas.width = 100;
      lightCanvas.height = 100;
      function checkBrightness() {
        lightCtx.drawImage(video, 0, 0, lightCanvas.width, lightCanvas.height);
        let imageData = lightCtx.getImageData(0, 0, lightCanvas.width, lightCanvas.height).data;
        let brightness = imageData.reduce((a, b) => a + b) / (imageData.length / 3);
        if ((stage === 2 && brightness > 150) || (stage === 7 && brightness > 180)) {
          progress += 0.05;
          if (progress >= 1) nextStage();
        }
        requestAnimationFrame(checkBrightness);
      }
      checkBrightness();
    });

    // Etapa 4: Tacto (nutrir)
    let touches = 0;
    canvas.addEventListener('touchstart', () => {
      if (stage === 4) {
        touches++;
        if (touches >= 5) nextStage();
      } else if (stage === 9) { // Cosechar
        progress += 0.2;
        if (progress >= 1) nextStage();
      }
    });

    // Etapa 6: Inclinación (podar)
    window.addEventListener('deviceorientation', (event) => {
      if (stage === 5) {
        if (Math.abs(event.beta) > 30) { // Inclinación en X
          progress += 0.1;
          if (progress >= 1) nextStage();
        }
      }
    });

    drawTree();
  </script>
</body>
</html>